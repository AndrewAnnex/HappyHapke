<html>
<head>
<title>Dirty Hapke</title>
<link rel="stylesheet" href="_static/css/page.css" type="text/css">
<link rel="stylesheet" href="_static/css/boilerplate.css" type="text/css">
<link rel="stylesheet" href="_static/css/fbm.css" type="text/css">
<link rel="stylesheet" href="_static/jquery/css/themes/base/jquery-ui.min.css">
<link rel="stylesheet" href="{{ static_url('styles.css') }}">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src="mpl.js"></script>
<script src="{{ static_url('details-shim.js') }}"></script>
<script src="{{ static_url('web_ui.js') }}"></script>
<script type="text/javascript">
function remove_phase_inputs(btn) {
  var div = $(btn).parent();
  if ($('.phase_inputs').length === 1) {
    $(':input', div).not(':button,:submit,:reset,:hidden').val('');
  } else {
    div.remove();
  }
  return false;
}
$(document).ready(WebUI('{{host}}', '{{uid}}'));
</script>
</head>
<body>

    <!--
    ...#
    ..##
    .#.#
    ...#
    ...#
    ...#
    .#####
    -->
    <details open='open'>
        <summary><span class='heading'>Initialization</span></summary>
        <form method='POST' enctype='multipart/form-data'>
            <section>
                <div class='param_group'>
                    <p>
                        Data files containing a single matrix each.
                        Either Matlab (.mat) format or ASCII text format is accepted.
                        Wavelength units should be either nm or microns (not wavenumbers).
                    </p>
                    <div id='addFiles'>
                        <label><input type='file' class="fileElement" name='file1' />VNIR spectrum - 1</label>
                        <label><input type='file' class="fileElement" name='file2' />VNIR spectrum - 2</label>
                        <label><input type='file' class="fileElement" name='file3' />VNIR spectrum - 3</label>
                    </div>
                    <span id='lnkAddMore'> Add More </span>
                    <label><input type='file' name='specwave_file' />Calibration wavelength</label>
                    <label><input type='file' name='calspec_file' />Calibration spectrum</label>
                </div>
                <script>
                    //Adding javascript for Section One
                    $('#lnkAddMore').click(function () {
                        var fileElements = $('#addFiles input.fileElement');
                        var index = (fileElements.length + 1);
                        $('#addFiles').append('<label><input class="fileElement" type="file" name=file' + index + ' />VNIR Spectrum - ' + index + '</label>');
                    });
                </script>
                <div class='param_group'>
                    <p>Known variables</p>
                    <label>
                        <input name='thetai' type='number' step='any' min='-90' max=90 value='-30' />
                        Incident angle (&theta;<sub>i</sub>), in degrees.
                    </label>
                    <label>
                        <input name='thetae' type='number' step='any' min='-90' max=90 value=0 />
                        Emission angle (&theta;<sub>e</sub>), in degrees.
                    </label>
                    <label>
                        <!-- <input name='n1' type='number' step='any' value='1.76575' /> -->
                        <input name='n1' type='number' step='any' value='1.5725' />
                        Average n, usually at the sodium D line.
                    </label>
                    <label>
                        <input type="checkbox" id="chkBg" name="Bg" value="Bg">
                        Opposition surge (B<sub>g</sub>), can be zero
                        if |&theta;<sub>i</sub> - &theta;<sub>e</sub>| &gt; 15.
                    </label>
                    <!-- <label>
                  <input name='QE' type='number' step='any' value=1 />
                  Extinction efficiency, set to 1 for closely-spaced particles.
                </label> -->
                </div>

                <div class='param_group'>
                    <p>Modeling choices</p>
                    <label>
                        <select id="ddlphase" name='phase_fn'>
                            <option value='legendre'>Legendre Polynomial</option>
                            <option value='dhg'>Double Heyney-Greenstein</option>
                            <option value='constant'>Constant (1)</option>
                        </select> Phase function
                    </label>
                    <label>
                        <select name='scatter_type'>
                            <option value='isotropic'>Isotropic</option>
                            <option selected value='lambertian'>Lambertian</option>
                        </select> Scattering model
                    </label>
                </div>
            </section>

            <input name='section' type='hidden' value='initialize' />
            <input type='submit' value='Run' />
        </form>
        <div class='results'></div>
    </details>

    <!--
    .#####
    #.....#
    ......#
    .#####
    #
    #
    #######
    -->
    <details>
        <summary><span class='heading'>Preprocessing</span></summary>
        <form method='POST'>
            <section>
                <div class='param_group'>
                    <label>Load Checkpoint</label><input type='file' class="fileElement" name='lcp' />
                    <p>
                        Usable range of wavelengths (in microns).
                        Use the plots above to determine good cutoffs.
                    </p>
                    <label>
                        <!-- <input name='low' type='number' step='any' value='0.405' /> -->
                        <input name='low' type='number' step='any' value='0.32' />
                        Lower bound of good region.
                    </label>
                    <label>
                        <!-- <input name='high' type='number' step='any' value='2.451' /> -->
                        <input name='high' type='number' step='any' value='2.550' />
                        Upper bound of good region.
                    </label>
                    <label>
                        <!-- <input name='UV' type='number' step='any' value='0.301' /> -->
                        <input name='UV' type='number' step='any' value='0.3' />
                        Lower bound after extrapolating the cropped spectrum.
                    </label>
                </div>

                <div class='param_group'>
                    <p>Interpolation options</p>
                    <label>
                        <!-- <input name='fit_order' type='number' step=1 value=0 min=0 max=5> -->
                        <input name='fit_order' type='number' step=1 value=1 min=0 max=5>
                        Polynomial order.
                    </label>
                    <label>
                        <input name='idx_in' type='number' step=1 value=3 min=0 max=5>
                        Initial Points to Fit
                    </label>
                </div>
            </section>

            <input name='section' type='hidden' value='preprocess' />
            <input type='submit' id='preprocess_submit' value='Run' />
        </form>
        <div class='results'></div>
    </details>
    <!--
    .#####...
    #.....#..
    ......#..
    .#####...
    ......#..
    #.....#..
    .#####...
    -->

    <details>
        <summary><span class='heading'>Solve for <i>k</i> (All Input Files)</span></summary>
        <form method='POST'>
            <label>Load Checkpoint</label><input type='file' class="fileElement" name='lcp' />
            <section>
                <div class='param_group'>
                    <div id="guess_group" style="display:flex"></div>
                </div>
            </section>

            <input name='key' type='hidden' value='file1' />
            <input name='section' type='hidden' value='solve_for_all_k' />
            <input type='submit' value='Run' />
        </form>
        <div class='results'></div>
    </details>

    <!--
    #
    #....#
    #....#
    #######
    .....#
    .....#
    .....#
    -->
    <details>
        <summary><span class='heading'>Solve for <i>k</i> (global)</span></summary>
        <form method='POST'>
            <label>Load Checkpoint</label><input type='file' class="fileElement" name='lcp' />
            <section>
                <div class='param_group'>
                    <p>Optimization Parameters</p>
                    <label>
                        <select id="ddlGuessKey" name='guess_key'></select>
                        Previous section to take the initial guess for k from.
                    </label>
                    <label>
                        <input name='lowk' type='number' step='any' value='1e-8' />
                        <input name='upk' type='number' step='any' value='0.1' />
                        Lower/upper bounds for each value in k.
                    </label>
                    <br>
                    <label>
                        <input name='num_solns' type='number' step='1' min='1' value='1' />
                        <div>
                            <p> MINIMIZATION PARAMETERS</p>
                            <div>
                                <div>
                                    <label>
                                        Max Function Evaluations D1: <input name='maxfun' type='number' value='1000' />
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        Function Tolerance (smaller is closer match): <input name='funtol' type='number' value='0.00000000000001' />
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        X Tolerance: <input name='xtol' type='number' value='0.000000001' step="any" />
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        Start Points: <input name='spts' type='number' step='1' value='5' />
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        Diff step: <input name='diff_step' type='number' step='any' value='0.000001' />
                                    </label>
                                </div>
                            </div>

                        </div>
                    </label>
                </div>

                <div class='param_group'>
                    <div id="boundnote">
                        <p><i> Note: The bounds for Henyey Greenstein Function - 0 <= b <= 1, 0 <= c <= 1. <br /> The bounds for Legendre Function - -1.7 <= b <= 1.7, -1 <= c <= 2</i></p>
                    </div>

                    <div id="bounds_group"></div>
                </div>
            </section>

            <input name='section' type='hidden' value='optimize_global_k' />
            <input type='submit' value='Run' />
        </form>
        <div class='results'></div>
    </details>

    <!--
    #######
    #
    #
    .#####
    ......#
    #.....#
    .#####
    -->
    <details>
        <summary><span class='heading'>Add in MIR data</span></summary>
        <form method='POST' enctype='multipart/form-data'>
            <label>Load Checkpoint</label><input type='file' class="fileElement" name='lcp' />
            <section>
                <div class='param_group'>
                    <p>
                        Matlab MAT-files containing a single matrix each.
                        Wavelength units should be either nm or microns (not wavenumbers).
                    </p>
                    <label><input type='file' name='mirv_file' />MIR wavelength (v)</label>
                    <label><input type='file' name='mirk_file' />MIR dispersion (k)</label>
                    <label>
                        Adjustment Type:
                        <select name='adjType'>
                            <option value='0'>None (Bridge gap with Line)</option>
                            <option value='1'>Asymmetric (Scales VNIR side of MIR k)</option>
                            <option value='2'>Symmetric (moves MIR k down by subtraction alone)</option>
                            <option value='3'>Cheng's Min/Max Adjustment</option>
                            <option value='4' selected> No MIR data </option>
                        </select>
                    </label>
                    <br />
                    <i>If you don't have MIR data, in Adjustment Type - use option <b> No MIR data</b> </i>
                </div>
            </section>

            <input name='section' type='hidden' value='add_mir_data' />
            <input type='submit' value='Run' />
        </form>
        <div class='results'></div>
    </details>

    <!--
    .#####
    #.....#
    #
    ######
    #.....#
    #.....#
    .#####
    -->
    <details>
        <summary><span class='heading'>Compute index of refraction (Kramers-Kronig)</span></summary>
        <form method='POST'>
            <label>Load Checkpoint</label><input type='file' class="fileElement" name='lcp' />
            <section>
                <div class='param_group'>
                    <p>Known variables</p>
                    <label>
                        <input name='anchor' type='number' step='any' value='0.58929' />
                        Anchor wavelength, at which the average n (above) was determined.
                    </label>
                </div>
            </section>

            <input name='section' type='hidden' value='run_sskk' />
            <input type='submit' value='Run' />
        </form>
        <div class='results'></div>
    </details>

    <!--
    #######
    #....#
    ....#
    ...#
    ..#
    ..#
    ..#
    -->
    <details>
        <summary><span class='heading'>Optimize phase function parameters</span></summary>
        <form method='POST' enctype='multipart/form-data'>
            <label>Load Checkpoint</label><input type='file' class="fileElement" name='lcp' />
            <section>
                <div class='param_group'>
                    <p>Phase Files</p>
                    <label>
                        Phase Angle Count: <input name='phaseAngleCount' id="phaseAngleCount" type='number' step='1' value='1' min='1' />
                        <span id="AddPhaseCount" /> Add Phase Angles </span>
                    </label>
                    <div id='addFilesPhase'></div>
                </div>
                <div class='param_group'>
                    <label>
                        Min Scale: <input name='minScale' type='number' step='any' value='0.01' min='0.01' max='9' />
                    </label>

                    <label>
                        Max Scale: <input name='maxScale' type='number' step='any' value='10' min='0.011' max='10' />
                    </label>

                    <label>
                        Min Offset: <input name='minOffset' type='number' step='any' value='-0.000000008' min="-0.00000008" max="0.0009" />
                    </label>

                    <label>
                        Max Offset: <input name='maxOffset' type='number' step='any' value='0.001' min='-0.000000007' max="0.001" />
                    </label>

                    <div>
                        <p> MINIMIZATION PARAMETERS</p>
                        <div>
                            <div>
                                <label>
                                    Max Function Evaluations D1: <input name='maxfun' type='number' value='1000' />
                                </label>
                            </div>
                            <div>
                                <label>
                                    Function Tolerance (smaller is closer match): <input name='funtol' type='number' value='0.00000000000001' />
                                </label>
                            </div>
                            <div>
                                <label>
                                    X Tolerance: <input name='xtol' type='number' value='0.000000001' step="any" />
                                </label>
                            </div> 
                            <div>
                                <label>
                                    Start Points: <input name='spts' type='number' step='1' value='5' />
                                </label>
                            </div>
                            <div> 
                                <label>
                                    Fit Order: <input name='fit_order' type='number' step='1' value='1' />
                                </label>
                            </div>

                            <div>
                                <label>
                                    Diff step: <input name='diff_step' type='number' step='any' value='0.000001' />
                                </label>
                            </div>
                        </div>

                    </div>
            </section>

            <input name='section' type='hidden' value='phase_solver' />
            <input type='submit' value='Run' />
        </form>
        <div class='results'></div>
    </details>

    <script>
        var $options;

        $('#preprocess_submit').click(function () {
            var phase = $("#ddlphase").val();
            var phasefn = phase == "dhg" ? "Double Heyney-Greenstein" : phase == "legendre" ? "Legendre" : "Constant";
            $('#ddlGuessKey, #bounds_group, #guess_group, #addFilesPhase').empty();
            var bgcheck = $('#chkBg').prop("checked");
            $(".fileElement").each(function (index) {
                
                grain_lb = 0;
                grain_ub = 0;
                var elementName = $(this).attr('name'); // Holds the fileId for the files added adhoc
                var fileAdded = $(this).val().split('\\').pop();

                switch (elementName) {
                    case 'file1':
                        grain_lb = 21;
                        grain_ub = 106;
                        break;
                    case 'file2':
                        grain_lb = 35;
                        grain_ub = 150;
                        break;
                    case 'file3':
                        grain_lb = 50;
                        grain_ub = 180;
                        break;
                }
                //Checks if the variable fileAdded is not an empty string
                if (fileAdded) { 
                    $("#ddlGuessKey").append('<option value="' + elementName + '">' + elementName + '</option>');
                    var local_bgmin = '';
                    var global_bgmin = '';
                    var phase_bgmin = '';
                    var bcmin = '';
                    if (bgcheck) {
                        global_bgmin = '<div>' +
                            '<p>B0:</p>' +
                            '<label>Lower Bounds: <input name="lowb0' + elementName + '"" type="number" step="any" value="0" /></label>' +
                            '<label>Upper Bounds:<input name="upb0' + elementName + '"" type="number" step="any" value="2" /></label>' +
                            '</div>' +
                            '<div>' +
                            '<p>h:</p>' +
                            '<label>Lower Bounds: <input name="lowh' + elementName + '"" type="number" step="any" value="0.00001" /></label>' +
                            '<label>Upper Bounds:<input name="uph' + elementName + '"" type="number" step="any" value="0.9" /></label>' +
                            '</div>';      

                        local_bgmin = '<label> B0: <input name = "b0_' + elementName + '" type = "number" step = "any" value = "0" /></label >' +
                            '<label> h: <input name = "h_' + elementName + '" type = "number" step = "any" value = "0.2" /></label >';

                        phase_bgmin = '<div class="pggdiv">' +
                            '<p class="pgg_p">B0:</p>' +
                            '<label>Lower Bounds:</label><input name="plb_b0_' + index + '"" type="number" step="any" value="0" />' +
                            '<label>Upper Bounds:<input name="pub_b0_' + index + '"" type="number" step="any" value="2" />' +
                            '<label>Guess:</label><input name = "p_b0_' + index + '" type = "number" step = "any" value = "1" />' +
                            '</div>' +
                            '<div class="pggdiv">' +
                            '<p class="pgg_p">h:</p>' +
                            '<label>Lower Bounds:</label><input name="plb_h_' + index + '"" type="number" step="any" value="0.00001" />' +
                            '<label>Upper Bounds:</label><input name="pub_h_' + index + '"" type="number" step="any" value="0.9" />' +
                            '<label>Guess:</label><input name = "p_h_' + index + '" type = "number" step = "any" value = "0.02" />' +
                            '</div>';

                    }
                    $('#guess_group').append('<div class="guess_grain_group" ><h3 class="param_grain_head" id="guesshead_' + index + '"></h3>' +
                        '<label> Coeff. b: <input name = "b_' + elementName +'" type = "number" step = "any" value = "0.1" /></label >' +
                        '<label> Coeff. c: <input name = "c_' + elementName +'" type = "number" step = "any" value = "0.3" /></label >' +
                        '<label> Filling Factor: <input name = "ff_' + elementName +'" type = "number" step = "any" value = "0.000000001" /></label >' +
                        '<label> Internal Scattering (s): <input name = "s_' + elementName +'" type = "number" step = "any" value = "0" /></label >' +
                        '<label> Grain Size (D): <input name = "D_' + elementName + '" type = "number" step = "any" value = "63" /></label >' +
                        local_bgmin+
                        '</div>');

                    if (phasefn != "Constant") {
                        $('#boundnote').show();                      
                        
                        bcmin = '<p>Coefficient b of ' + phasefn + ' polynomial:</p>' +
                            '<label>Lower Bounds: <input name="lowb' + elementName + '"" type="number" step="any" value="-1.7" /></label>' +
                            '<label>Upper Bounds:<input name="upb' + elementName + '"" type="number" step="any" value="1.7" /></label>' +
                            '</div>' +
                            '<div>' +
                            '<p>Coefficient c of ' + phasefn + ' polynomial:</p>' +
                            '<label>Lower Bounds: <input name="lowc' + elementName + '"" type="number" step="any" value="-1.0" /></label>' +
                            '<label>Upper Bounds:<input name="upc' + elementName + '"" type="number" step="any" value="1.0" /></label>' +
                            '</div>' ;
                    }
                    else {
                        $('#boundnote').hide();
                    }

                    $("#bounds_group").append('<div class="grain_group" style="display:flex"><h3 class="param_grain_head" id="head_' + index + '"></h3>' +
                        '<div>' + bcmin +
                        '<div>' +
                        '<p>Internal Scattering:</p>' +
                        '<label>Lower Bounds: <input name="lows' + elementName + '"" type="number" step="any" value="0" /></label>' +
                        '<label>Upper Bounds:<input name="ups' + elementName + '"" type="number" step="any" value="0.06" /></label>' +
                        '</div>' +
                        '<div>' +
                        '<p>Grain Size:</p>' +
                        '<label>Lower Bounds: <input name="lowD' + elementName + '"" type="number" step="any" value="' + grain_lb + '" /></label>' +
                        '<label>Upper Bounds:<input name="upD' + elementName + '"" type="number" step="any" value="' + grain_ub + '" /></label>' +
                        '</div>' + global_bgmin +
                        '</div>');

                    $('#addFilesPhase').append('<div class="pfilesecs" id="pfilesec_' + index + '">' + '<h3 class="param_pfile_head" id="pfile_' + index + '"></h3>' +
                        '<span class="p_grain_group" style="display:flex">' +
                        '<div class="pggdiv">' +
                        '<p class="pgg_p">Coeff. b:</p>' +
                        '<label>Lower Bounds:</label><input name="plb_b_' + index + '"" type="number" step="any" value="-1.7" />' +
                        '<label>Upper Bounds:</label><input name="pub_b_' + index + '"" type="number" step="any" value="1.7" />' +
                        '<label>Guess:</label ><input name = "p_b_' + index + '" type = "number" step = "any" value = "0.1" />' +
                        '</div>' +
                        '<div class="pggdiv">' +
                        '<p class="pgg_p">Coeff c:</p>' + 
                        '<label>Lower Bounds:</label><input name="plb_c_' + index + '"" type="number" step="any" value="-1.0" />' +
                        '<label>Upper Bounds:</label><input name="pub_c_' + index + '"" type="number" step="any" value="1.0" />' +
                        '<label>Guess:</label ><input name = "p_c_' + index + '" type = "number" step = "any" value = "0.3" />' +
                        '</div>' +
                        '<div class="pggdiv">' +
                        '<p class="pgg_p">Scat. s:</p>' +
                        '<label>Lower Bounds:</label><input name="plb_s_' + index + '"" type="number" step="any" value="0" />' +
                        '<label>Upper Bounds:<input name="pub_s_' + index + '"" type="number" step="any" value="0.06" />' +
                        '<label>Guess:</label><input name = "p_s_' + index + '" type = "number" step = "any" value = "0" />' +
                        '</div>' +
                        '<div class="pggdiv">' +
                        '<p class="pgg_p">Grain Size (D):</p>' +
                        '<label>Lower Bounds:</label><input name="plb_d_' + index + '"" type="number" step="any" value="' + grain_lb + '" />' +
                        '<label>Upper Bounds:</label><input name="pub_d_' + index + '"" type="number" step="any" value="' + grain_ub + '" />' +
                        '<label>Guess:</label><input name = "p_d_' + index + '" type = "number" step = "any" value = "63" />' +
                        '</div>' +
                        phase_bgmin +
                        '</span>');

                    $('#pfile_' + index).text(elementName + ":" + fileAdded);
                    $('#guesshead_' + index).text(elementName + ":" + fileAdded);
                    $('#head_' + index).text(elementName + ":" + fileAdded);
                }
            });

            $('#AddPhaseCount').click(function () {
                $('.phaseangle').remove();
                var count = $('#phaseAngleCount').val()
                for (var i = 0; i < count; i++){
                $(".fileElement").each(function (index) {
                    var elementName = $(this).attr('name'); // Holds the fileId for the files added adhoc
                    var fileAdded = $(this).val().split('\\').pop();
                    if (fileAdded) {
                        var selector = 'pfilesec_' + index;
                        var fileElements = $('#' + selector + ' input.pfileElement');
                        var id = (fileElements.length);
                        $('#' + selector).append('<div class="phaseangle">' +
                            '<label><input type="file" class="pfileElement" name="filepfile_' + index + '_' + id + '"/></label>' +
                            '<label>Phase Angle (I): <input name="pfile_i_' + index + '_' + id + '" type="number" step="10" value="10" /></label>' +
                            '<label>Phase Angle (E): <input name="pfile_e_' + index + '_' + id + '" type="number" step="10" value="10" /></label>' +
                            '</div >');
                    }
                });
                }
            });

        }); //Preprocess submit end

        //Adding javascript for Section Phase Angle 
        

        
    </script>

</body>

</html>